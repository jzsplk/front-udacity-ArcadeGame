function addEnemy(e){for(var t=0;t<e;t++){var r=new Enemy;r.initProperty(),allEnemies.push(r)}}function addObstacle(e){for(var t=0;t<e;t++)if(pavement.occupiedNumber()<9){var r=new Obstacle;allObstacles.push(r)}}function addRandomTreasure(e){for(var t=10,r=10,a=10,s=10,i=10,n=50,o=0;o<e;o++){var l=Math.ceil(50*Math.random());if(l<10)var c=new Heart;else if(l<20)var c=new Key;else if(l<30)var c=new BlueGem;else if(l<40)var c=new GreenGem;else var c=new OrangeGem;allTreasures.push(c)}}function collision(e){return e instanceof Enemy&&e.y===player.y&&Math.abs(e.x-player.x)<50||e instanceof Obstacle&&e.y===player.y&&e.x===player.x}function checkCollisionsWithObstacle(e){for(var t=0;t<e.length;t++)if(collision(e[t]))return!0}var WIDTH=101,HEIGHT=83,BASIC_SPEED=100,HighScore=0,ScoreFlag=!0,pavement=function(){var e=[];return e.reset=function(){for(var t=0;t<4;t++){e[t]=[];for(var r=0;r<5;r++)e[t][r]=!1}},e.occupiedNumber=function(){var e=0;return this.forEach(function(t){t.forEach(function(t){e+=t?1:0})}),e},e.reset(),e}(),timerId,BlueGemAction=function(){leftTime=5e3,startTimer()},leftTime=0,startTimer=function(){Engine.setTimeSpeed(.2);var e=5e3;leftTime=Math.min(5e3,leftTime);var t=10;clearInterval(timerId),timerId=setInterval(function(){leftTime-=10,(leftTime=Math.max(leftTime-10,0))<=0&&(Engine.setTimeSpeed(1),clearInterval(timerId))},10)},Enemy=function(){this.x=3*WIDTH,this.y=2*HEIGHT,this.speed=BASIC_SPEED,this.damage=4,this.sprite="images/enemy-bug.png"};Enemy.prototype.initProperty=function(){this.x=-Math.ceil(3*Math.random())*WIDTH,this.y=Math.ceil(4*Math.random())*HEIGHT,this.speed=BASIC_SPEED+50*Math.ceil(3*Math.random())},Enemy.prototype.move=function(e){this.x+=e*this.speed},Enemy.prototype.update=function(e){this.move(e),this.x>5*WIDTH&&this.initProperty()},Enemy.prototype.render=function(){ctx.drawImage(Resources.get(this.sprite),this.x,this.y+15,60,105)};var Entity=function(){this.initPosition()};Entity.prototype.initPosition=function(){var e,t;for(e=Math.floor(5*Math.random()),t=Math.floor(4*Math.random()),this.x=WIDTH*e,this.y=HEIGHT*(t+1);!0===pavement[t][e]||this.x===player.x&&this.y===player.y;)e=Math.floor(5*Math.random()),t=Math.floor(4*Math.random()),this.x=WIDTH*e,this.y=HEIGHT*(t+1);pavement[t][e]=!0,console.log(pavement)};var Obstacle=function(){Entity.call(this),this.sprite="images/Rock.png"};Obstacle.prototype=Object.create(Entity.prototype),Obstacle.prototype.constructor=Obstacle,Obstacle.prototype.render=function(){ctx.drawImage(Resources.get(this.sprite),this.x+20,this.y+15,60,105)};var removeObstacle=function(){if(0!==allObstacles.length&&!(player.keynum<=0))for(var e=0;e<allObstacles.length;e++)if(player.x===allObstacles[e].x&&player.keynum>0){var t=allObstacles[e].y/HEIGHT-1,r=allObstacles[e].x/WIDTH;pavement[t][r]=!1,player.keynum-=1,allObstacles.splice(e,1)}},Treasure=function(){Entity.call(this)};Treasure.prototype=Object.create(Entity.prototype),Treasure.prototype.constructor=Treasure,Treasure.prototype.render=function(){ctx.drawImage(Resources.get(this.sprite),this.x+20,this.y+15,60,105)};var hitTreasureAction=function(e){e instanceof Key?player.keynum+=1:e instanceof Heart?player.hp<70?player.hp+=30:player.hp=100:e instanceof BlueGem?BlueGemAction():e instanceof GreenGem?player.jump_distance=2:e instanceof OrangeGem&&allEnemies.forEach(function(e){e.x=6*HEIGHT})},hitTreasure=function(){for(var e=0;e<allTreasures.length;e++)if(player.x===allTreasures[e].x&&player.y===allTreasures[e].y){var t=allTreasures[e].y/HEIGHT-1,r=allTreasures[e].x/WIDTH;pavement[t][r]=!1,hitTreasureAction(allTreasures[e]),allTreasures.splice(e,1)}},Key=function(){Treasure.call(this),this.sprite="images/Key.png"};Key.prototype=Object.create(Treasure.prototype),Key.prototype.constructor=Key;var Heart=function(){Treasure.call(this),this.sprite="images/Heart.png"};Heart.prototype=Object.create(Treasure.prototype),Heart.prototype.constructor=Heart;var BlueGem=function(){Treasure.call(this),this.sprite="images/Gem Blue.png"};BlueGem.prototype=Object.create(Treasure.prototype),BlueGem.prototype.constructor=BlueGem;var GreenGem=function(){Treasure.call(this),this.sprite="images/Gem Green.png"};GreenGem.prototype=Object.create(Treasure.prototype),GreenGem.prototype.constructor=GreenGem;var OrangeGem=function(){Treasure.call(this),this.sprite="images/Gem Orange.png"};OrangeGem.prototype=Object.create(Treasure.prototype),OrangeGem.prototype.constructor=OrangeGem;var Player=function(){this.x=3*WIDTH,this.y=5*HEIGHT,this.hp=100,this.score=0,this.keynum=0,this.jump_distance=1,this.sprite="images/char-boy.png"};Player.prototype.resetPlayer=function(){var e=setTimeout(function(){player.y=5*HEIGHT,player.x=2*WIDTH,player.jump_distance=1,ScoreFlag=!0},300)},Player.prototype.checkCollisionsWithEnemy=function(e){e.forEach(function(e){collision(e)&&(player.x=e.x)})},Player.prototype.checkCollisionsWithObstacle=function(e){e.forEach(function(e){collision(e)})},Player.prototype.update=function(e){if(this.y<HEIGHT){if(this.y=0,!0===ScoreFlag){this.score+=100,addRandomTreasure(1);Math.random()<.5&&addObstacle(1),ScoreFlag=!1}this.resetPlayer()}else this.y>5*HEIGHT&&(this.y=5*HEIGHT);this.checkCollisionsWithEnemy(allEnemies),this.hp<=0&&(alert("game over! 得分为："+player.score),this.score=0,player.resetPlayer(),this.hp=100),$(".hp").html(player.hp),$(".score").html(player.score),$(".highscore").html(HighScore),$(".keynumber").html(player.keynum),this.x<0?this.x=0:this.x>4*WIDTH&&(this.x=4*WIDTH),HighScore<this.score&&(HighScore=this.score),hitTreasure()},Player.prototype.render=function(){ctx.drawImage(Resources.get(this.sprite),this.x,this.y-10)},Player.prototype.handleInput=function(e){var t=this.x,r=this.y;switch(e){case"left":this.x-=player.jump_distance*WIDTH;break;case"right":this.x+=player.jump_distance*WIDTH;break;case"up":this.y-=player.jump_distance*HEIGHT;break;case"down":this.y+=player.jump_distance*HEIGHT;break;case"space":removeObstacle();break;default:return}checkCollisionsWithObstacle(allObstacles)&&(this.x=t,this.y=r)};var player=new Player,allEnemies=[],allObstacles=[],allTreasures=[],initGame=function(){addObstacle(0),addEnemy(5),addRandomTreasure(2)};initGame(),document.addEventListener("keyup",function(e){var t={37:"left",38:"up",39:"right",40:"down",32:"space"};player.handleInput(t[e.keyCode])});